---
title: 五：系统设计目标（三）：如何让系统易于扩展
date: 2021-02-22 18:48:27
tags:
- 高并发
- 架构
category: 高并发
---

当我们面对突发流量的时候，架构改造已经来不及了，通常的解决方案就是扩容。

### <font color = "dd0000"> 为什么提升扩展性会很复杂 </font>

之前我们讲到过，增加系统的并行处理能力时有拐点的，当并行任务过多，系统会因为争夺资源而达到性能拐点。

而对于多台机器组成的集群来说也是如此，集群系统中，不同的系统分层上可能存在一些“瓶颈点”，这些瓶颈点制约着系统的横向扩张能力。

比方说，你系统的流量时每秒1000次请求，对数据库的请求量也是每秒1000次。如果流量增加10倍，虽然系统可以通过扩容正常服务，数据库却成为了净瓶。
再比如说，单机网络带宽是50Mbps，那么扩容到30台机器，前端负载均衡的带宽就超过了千兆带宽的限制，也会成为瓶颈点。那么，我们的系统中存在哪些服务
会成为制约系统扩展的重要因素呢？

其实，无状态的服务和组件更易于扩展，而像Mysql这种存储服务是有状态的，就比较难扩展。因为向存储集群中增加或者减少机器的时候，会涉及到数据的迁徙，
而一般传统的关系型数据库都不支持。这就是为什么提升系统扩展性会很复杂的原因。

除此之外，我们需要站在整体架构的角度，而不仅仅是业务服务器的角度来考虑扩展性。所以说，数据库，缓存，依赖的第三方，负载均衡，交换机带宽等等都是系统扩展时
需要考虑的因素。我们要知道系统并发到了某一个量级之后，哪一个因素会成为我们的瓶颈点，从而针对性的进行扩展。


### <font color = "dd0000"> 高可扩展性的设计思路 </font>
拆分是提升系统扩展性最重要的思路。他会把庞杂的系统拆分成独立的，由单一负责的模块。这样一个一个小模块的扩展性就像对于简单一点。

对于不同类型的模块，我们拆分上遵循的原则是不一样的。举例来说，加入一个社区，就有可能有5个模块。
+ 用户：负责维护社区用户信息，注册和登录等：
+ 关系：用户之间关注，好友，拉黑等关系的维护；
+ 内容：社区发的内容，就像朋友圈或微博；
+ 评论，赞：用户常用的互动措施等；
+ 搜索：用户的搜索，内容的搜索等；

而部署方式遵照最简单的三层部署架构，负载均衡负责请求的分发，应用服务器负责业务逻辑处理，数据库负责数据的存储落地。这时，所有的模块的业务代码都混在一起，
数据也都在一个库里。

1. 存储层的扩展性

   <br/>无论是存储的数据量，还是并发访问量，不同的业务模块之间的量级相差很大，比如说成熟社区中，关系的数据量是远远大于用户数量的，但是用户数据的访问量
却远比关系数据要大。所以假如存储目前的瓶颈点是容量，那么我们只针对关系模块的数据做拆分就好了，而不需要拆分用户模块的数据。所以存储拆分首先考虑的维度是业务为度。

   <br/>拆分之后，这个简单的社区系统，数据库就分成了用户库，内容库，评论库，点赞库和关系库。这么做还能隔离故障，不会互相影响。按照业务拆分，在某一定的
程度上提升了系统的扩展性，但系统运行时间长了之后，单一的业务数据在容量和并发请求量上仍会超过单机的限制。这时，我们就需要针对数据库进行二次拆分。

   <br/>这次拆分是按照数据库特征做水平拆分，比如说我们可以用用户库增加两个节点，然后按照某些算法将用户的数据拆分到三个库里面，具体的分表分库算法
会在后面细讲。
   
   <br/>水平拆分之后，就可以让数据库突破单机的限制了，但要注意，频繁的增加节点会需要多次手动地迁移数据，成本会非常高，所以扩容这种事最好一次到位。

   <br/>当数据库按照业务和数据维度拆分之后，我们尽量不要使用事务。因为当一个事务中同时更新不同数据库时，需要使用二阶段提交，来协调所有数据库，要么全部完成，
要么全部失败，这个协调成本会随着资源的扩展不断提高，最终到达无法承受的成都。


2. 业务层的扩展性

   <br/>我们一般从三个维度考虑业务层的拆分方案，分别是业务维度，重要性维度和请求来源维度。

   <br/>首先，我们需要把相同业务的服务拆分成单独的业务池，比如社区系统，我们按照业务维度，拆分成用户池，内容池，关系池，评论池，点赞池和搜索池。

   <br/>每个业务依赖独立的数据库资源，不会依赖其他业务的数据库资源。这样当某一个业务的接口成为瓶颈的时候，我们只需要扩展业务的池子，以及确认上下游
的依赖方就好了，这样就减少了扩容的复杂度。

   <br/>除此之外，我们还可以根据业务接口的重要程度，把业务分成核心池和非核心池。比方说，就关系池而言，关注，取消关注接口相对重要，拉黑和取消拉黑就不那么
重要。这样我们可以优先保持核心池的性能，当整体流量上升的时候优先扩容核心池，降级非核心池接口，从而保证稳定性。
   
   <br/>最后还可以根据接入客户端类型的不同拆分业务池，比如，服务于客户端接口的业务可以定义为外网池，服务于小程序或者HTML5页面的业务可以定位为H5池，
服务于内部其他部门的业务员可以定义为内网池等等。
   









